<!DOCTYPE html>
<html>

<head>
  <title>Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body { padding: 1rem; }
    #loginDiv { max-width: 300px; margin: auto; }
    #confirmModal, #notifyModal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;
    }
    #confirmModal .card, #notifyModal .card { max-width: 300px; text-align: center; padding: 1rem; }
    #mobileLog { background: #eee; padding: 10px; max-height: 200px; overflow: auto; margin-bottom: 1rem; font-size: 0.9rem; }
  </style>
</head>

<body>

  <h3>Debug Log</h3>
  <pre id="mobileLog"></pre>

  <!-- Delete Confirmation Modal -->
  <div id="confirmModal">
    <div class="card">
      <p id="confirmMessage">Are you sure?</p>
      <div class="d-flex justify-content-around mt-3">
        <button id="confirmYes" class="btn btn-danger">Yes</button>
        <button id="confirmNo" class="btn btn-secondary">No</button>
      </div>
    </div>
  </div>

  <!-- Upload Notification Modal -->
  <div id="notifyModal">
    <div class="card">
      <p id="notifyMessage"></p>
      <button id="notifyOk" class="btn btn-primary mt-2">OK</button>
    </div>
  </div>

  <!-- Login -->
  <h2 class="text-center">Admin Login</h2>
  <div id="loginDiv">
    <input type="password" id="password" placeholder="Enter password" class="form-control mb-2">
    <button id="loginBtn" class="btn btn-primary w-100">Login</button>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" style="display:none;">
    <h2>Create / Edit Post</h2>
    <p id="remainingUploads" class="text-muted"></p>
    <form id="postForm">
      <input type="text" id="title" placeholder="Title" class="form-control mb-2" required>
      <textarea id="description" placeholder="Description" class="form-control mb-2"></textarea>
      <input type="file" id="image" class="form-control mb-2">
      <input type="text" id="imageUrl" placeholder="Or image URL" class="form-control mb-2">
      <button type="submit" id="uploadBtn" class="btn btn-success mb-2">Upload Post</button>
      <button type="button" id="cancelEditBtn" class="btn btn-warning mb-2" style="display:none;">Cancel Edit</button>
    </form>

    <h2>All Posts</h2>
    <div id="posts" class="row"></div>
  </div>

  <script>
    // ===============================
    // MOBILE LOGGING
    // ===============================
    function logMobile(msg, isError = false) {
      const el = document.getElementById('mobileLog');
      const line = document.createElement('div');
      line.textContent = msg;
      if (isError) line.style.color = 'red';
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    }

    // ===============================
    // PASSWORD HASH
    // ===============================
    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    const HASHED_PASSWORD = "4ded3da94e01245f2a401bbbafb80128c80e4f6febeb04e1a684c2503a8d9dc2"; // admin123

    // ===============================
    // MODALS
    // ===============================
    const confirmModal = document.getElementById('confirmModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmYes = document.getElementById('confirmYes');
    const confirmNo = document.getElementById('confirmNo');
    const notifyModal = document.getElementById('notifyModal');
    const notifyMessage = document.getElementById('notifyMessage');
    document.getElementById('notifyOk').onclick = () => notifyModal.style.display = "none";

    function showConfirm(message, callbackYes) {
      confirmMessage.textContent = message;
      confirmModal.style.display = "flex";
      function yesHandler() { confirmModal.style.display = "none"; cleanup(); callbackYes(); }
      function noHandler() { confirmModal.style.display = "none"; cleanup(); }
      function cleanup() { confirmYes.removeEventListener('click', yesHandler); confirmNo.removeEventListener('click', noHandler); }
      confirmYes.addEventListener('click', yesHandler);
      confirmNo.addEventListener('click', noHandler);
    }

    function showNotification(message) { notifyMessage.textContent = message; notifyModal.style.display = "flex"; }

    // ===============================
    // LOGIN
    // ===============================
    const loginBtn = document.getElementById('loginBtn');
    const passwordInput = document.getElementById('password');
    const loginDiv = document.getElementById('loginDiv');
    const adminPanel = document.getElementById('adminPanel');

    loginBtn.addEventListener('click', async () => {
      const hash = await sha256(passwordInput.value.trim());
      if (hash === HASHED_PASSWORD) {
        sessionStorage.setItem('loggedIn', 'true');
        loginDiv.style.display = "none";
        adminPanel.style.display = "block";
        posts = await loadPosts();
        renderPosts();
      } else alert("Incorrect password!");
    });

    if (sessionStorage.getItem('loggedIn') === 'true') {
      loginDiv.style.display = "none";
      adminPanel.style.display = "block";
    }

    // ===============================
    // POSTS LOGIC
    // ===============================
    let posts = [];
    let editIndex = -1;
    const MAX_POSTS = 10;
    const form = document.getElementById('postForm');
    const remainingUploadsEl = document.getElementById('remainingUploads');
    const uploadBtn = document.getElementById('uploadBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');

    function updateRemainingUploads() {
      const rem = MAX_POSTS - posts.length + (editIndex >= 0 ? 1 : 0);
      remainingUploadsEl.textContent = `Remaining uploads: ${rem}`;
      uploadBtn.disabled = rem <= 0;
    }

    async function loadPosts() {
      try {
        const res = await fetch("/api/save-posts", { method: "GET" });
        const text = await res.text();
        if (!res.ok) { logMobile(`Failed to load posts: ${res.status} - ${text}`, true); return []; }
        const data = JSON.parse(text);
        if (data.logs) data.logs.forEach(msg => logMobile(msg, msg.toLowerCase().includes("error")));
        return data.posts || [];
      } catch (err) { logMobile("Load posts error: " + err, true); return []; }
    }

    async function savePostsToGitHub(posts) {
      try {
        const res = await fetch("/api/save-posts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ posts }),
        });
        const text = await res.text();
        if (!res.ok) { logMobile(`Upload failed: ${res.status} - ${text}`, true); showNotification("Upload failed. Check mobile log"); return false; }
        try {
          const data = JSON.parse(text);
          if (data.logs) data.logs.forEach(msg => logMobile(msg, msg.toLowerCase().includes("error")));
          if (data.success) return true;
          logMobile("Upload failed: success=false - " + JSON.stringify(data), true);
          showNotification("Upload failed. Check mobile log");
          return false;
        } catch { logMobile("Upload returned non-JSON, assuming success", false); return true; }
      } catch (err) { logMobile("Upload error: " + err, true); showNotification("Upload failed. Check mobile log"); return false; }
    }

    // Compress images before upload
    async function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.7) {
      return new Promise(resolve => {
        const img = new Image();
        const reader = new FileReader();
        reader.onload = e => img.src = e.target.result;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let { width, height } = img;
          if (width > height && width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
          else if (height > width && height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          resolve(canvas.toDataURL('image/jpeg', quality));
        };
        reader.readAsDataURL(file);
      });
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const file = document.getElementById('image').files[0];
      const imageUrl = document.getElementById('imageUrl').value.trim();

      if (!file && !imageUrl && editIndex === -1) { showNotification("Please select an image or enter a URL."); return; }

      async function save(imageData) {
        const date = new Date().toLocaleString();
        if (editIndex >= 0) { 
          posts[editIndex] = { title, description, image: imageData || posts[editIndex].image, date: posts[editIndex].date };
          editIndex = -1; cancelEditBtn.style.display = "none"; 
        } else posts.push({ title, description, image: imageData, date });
        const success = await savePostsToGitHub(posts);
        if (success) { posts = await loadPosts(); renderPosts(); form.reset(); uploadBtn.textContent = "Upload Post"; showNotification("Post saved!"); }
      }

      if (file) save(await compressImage(file));
      else save(imageUrl);
    });

    function renderPosts() {
      const container = document.getElementById('posts'); 
      container.innerHTML = "";
      posts.forEach((post, index) => {
        container.innerHTML += `<div class="col-md-4 mb-4"><div class="card">${post.image ? `<img src="${post.image}" class="card-img-top">` : ""}<div class="card-body"><h5 class="card-title">${post.title}</h5><p class="card-text">${post.description}</p><p class="text-muted"><small>${post.date}</small></p><button class="btn btn-warning btn-sm" onclick="editPost(${index})">Edit</button> <button class="btn btn-danger btn-sm" onclick="deletePost(${index})">Delete</button></div></div></div>`;
      });
      updateRemainingUploads();
    }

    window.editPost = function(i) { 
      editIndex = i; 
      const p = posts[i]; 
      document.getElementById('title').value = p.title; 
      document.getElementById('description').value = p.description; 
      uploadBtn.textContent = "Save Changes"; 
      cancelEditBtn.style.display = "inline-block"; 
    }

    window.deletePost = function(i) { 
      showConfirm("Delete this post?", async () => { 
        posts.splice(i, 1); 
        await savePostsToGitHub(posts); 
        posts = await loadPosts(); 
        renderPosts(); 
      }); 
    }

    cancelEditBtn.onclick = () => { editIndex = -1; form.reset(); cancelEditBtn.style.display = "none"; uploadBtn.textContent = "Upload Post"; }

  </script>
</body>
</html>
