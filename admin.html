<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body { padding: 1rem; }
    #loginDiv { max-width: 300px; margin: auto; }

    /* Modals hidden by default */
    #confirmModal, #notifyModal {
      display:none;
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      justify-content:center; align-items:center;
      z-index:1000;
    }
    #confirmModal .card, #notifyModal .card {
      max-width:300px;
      text-align:center;
      padding:1rem;
      border-radius:8px;
      background:white;
    }
  </style>
</head>
<body>

<!-- Delete Confirmation Modal -->
<div id="confirmModal">
  <div class="card">
    <p id="confirmMessage">Are you sure?</p>
    <div class="d-flex justify-content-around mt-3">
      <button id="confirmYes" class="btn btn-danger">Yes</button>
      <button id="confirmNo" class="btn btn-secondary">No</button>
    </div>
  </div>
</div>

<!-- Upload Notification Modal -->
<div id="notifyModal">
  <div class="card">
    <p id="notifyMessage"></p>
    <button id="notifyOk" class="btn btn-primary mt-2">OK</button>
  </div>
</div>

<!-- Login -->
<h2 class="text-center">Admin Login</h2>
<div id="loginDiv">
  <input type="password" id="password" placeholder="Enter password" class="form-control mb-2">
  <button id="loginBtn" class="btn btn-primary w-100">Login</button>
</div>

<!-- Admin Panel -->
<div id="adminPanel" style="display:none;">
  <h2>Create / Edit Post</h2>
  <p id="remainingUploads" class="text-muted"></p>
  <form id="postForm">
    <input type="text" id="title" placeholder="Title" class="form-control mb-2" required>
    <textarea id="description" placeholder="Description" class="form-control mb-2"></textarea>
    <input type="file" id="image" class="form-control mb-2">
    <button type="submit" id="uploadBtn" class="btn btn-success mb-2">Upload Post</button>
    <button type="button" id="cancelEditBtn" class="btn btn-warning mb-2" style="display:none;">Cancel Edit</button>
  </form>

  <h2>All Posts</h2>
  <div id="posts" class="row"></div>
</div>

<script>
  // ===== SHA-256 login =====
  async function sha256(message){
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
  }
  const HASHED_PASSWORD = "a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3"; // admin123

  // ===== MODALS =====
  const confirmModal = document.getElementById('confirmModal');
  const confirmMessage = document.getElementById('confirmMessage');
  const confirmYes = document.getElementById('confirmYes');
  const confirmNo = document.getElementById('confirmNo');

  const notifyModal = document.getElementById('notifyModal');
  const notifyMessage = document.getElementById('notifyMessage');
  const notifyOk = document.getElementById('notifyOk');

  function showConfirm(message, callbackYes){
    confirmMessage.textContent = message;
    confirmModal.style.display = "flex";
    function yesHandler(){ confirmModal.style.display="none"; confirmYes.removeEventListener('click', yesHandler); confirmNo.removeEventListener('click', noHandler); callbackYes(); }
    function noHandler(){ confirmModal.style.display="none"; confirmYes.removeEventListener('click', yesHandler); confirmNo.removeEventListener('click', noHandler); }
    confirmYes.addEventListener('click', yesHandler);
    confirmNo.addEventListener('click', noHandler);
  }

  function showNotification(message){
    notifyMessage.textContent = message;
    notifyModal.style.display="flex";
    notifyOk.onclick = ()=>{ notifyModal.style.display="none"; };
  }

  // ===== LOGIN =====
  const loginBtn = document.getElementById('loginBtn');
  const passwordInput = document.getElementById('password');
  const loginDiv = document.getElementById('loginDiv');
  const adminPanel = document.getElementById('adminPanel');

  async function handleLogin() {
    const password = passwordInput.value.trim();
    if(!password){ alert("Please enter a password!"); return; }
    const hash = await sha256(password);
    if(hash === HASHED_PASSWORD){
      sessionStorage.setItem('loggedIn','true');
      loginDiv.style.display="none";
      adminPanel.style.display="block";
      renderPosts();
    } else {
      alert("Incorrect password!");
      console.log("Password entered:", password);
      console.log("Computed hash:", hash);
    }
  }
  loginBtn.addEventListener('click', handleLogin);

  // Auto-login if session exists
  (async function(){
    if(sessionStorage.getItem('loggedIn') === 'true'){
      loginDiv.style.display="none";
      adminPanel.style.display="block";
      renderPosts();
    }
  })();

  // ===== POSTS =====
  const form = document.getElementById('postForm');
  const remainingUploadsEl = document.getElementById('remainingUploads');
  const uploadBtn = document.getElementById('uploadBtn');
  const cancelEditBtn = document.getElementById('cancelEditBtn');

  const MAX_POSTS = 10;
  const MAX_SIZE = 3*1024*1024; // 3MB
  const MAX_WIDTH = 1024;
  const MAX_HEIGHT = 1024;

  let posts = JSON.parse(localStorage.getItem('posts') || '[]');
  let editIndex = -1;

  function updateRemainingUploads(){
    const remaining = MAX_POSTS - posts.length + (editIndex>=0?1:0);
    remainingUploadsEl.textContent = `Remaining uploads: ${remaining}`;
    uploadBtn.disabled = remaining<=0;
  }

  function resizeImage(file,maxW,maxH,callback){
    const reader = new FileReader();
    reader.onload=function(e){
      const img = new Image();
      img.onload=function(){
        let canvas=document.createElement('canvas');
        let w=img.width, h=img.height;
        if(w>maxW){ h*=maxW/w; w=maxW; }
        if(h>maxH){ w*=maxH/h; h=maxH; }
        canvas.width=w; canvas.height=h;
        canvas.getContext("2d").drawImage(img,0,0,w,h);
        callback(canvas.toDataURL("image/jpeg",0.8));
      }
      img.src=e.target.result;
    }
    reader.readAsDataURL(file);
  }

  form.addEventListener('submit',(e)=>{
    e.preventDefault();
    const title = document.getElementById('title').value;
    const description = document.getElementById('description').value;
    const file = document.getElementById('image').files[0];

    function savePost(imageBase64){
      const date = new Date().toLocaleString();
      if(editIndex>=0){
        posts[editIndex]={title,description,image:imageBase64||posts[editIndex].image,date:posts[editIndex].date};
        editIndex=-1;
        cancelEditBtn.style.display="none";
      } else { posts.push({title,description,image:imageBase64,date}); }
      localStorage.setItem('posts',JSON.stringify(posts));
      renderPosts();
      form.reset();
      uploadBtn.textContent="Upload Post";
      showNotification("Post saved successfully!");
    }

    if(file){
      if(file.size>MAX_SIZE){ alert("File too large! Max 3MB."); return; }
      resizeImage(file,MAX_WIDTH,MAX_HEIGHT,savePost);
    } else { savePost(null); }
  });

  cancelEditBtn.addEventListener('click',()=>{
    editIndex=-1;
    form.reset();
    cancelEditBtn.style.display="none";
    uploadBtn.textContent="Upload Post";
    updateRemainingUploads();
  });

  function renderPosts(){
    const container = document.getElementById('posts');
    container.innerHTML="";
    posts.forEach((post,index)=>{
      container.innerHTML += `
      <div class="col-md-4 mb-4">
        <div class="card">
          ${post.image?`<img src="${post.image}" class="card-img-top">`:''}
          <div class="card-body">
            <h5 class="card-title">${post.title}</h5>
            <p class="card-text">${post.description}</p>
            <p class="text-muted"><small>Posted on: ${post.date}</small></p>
            <button class="btn btn-warning btn-sm" onclick="editPost(${index})">Edit</button>
            <button class="btn btn-danger btn-sm" onclick="deletePost(${index})">Delete</button>
          </div>
        </div>
      </div>`;
    });
    updateRemainingUploads();
  }

  function deletePost(index){
    showConfirm("Are you sure you want to delete this post?", ()=>{
      posts.splice(index,1);
      localStorage.setItem('posts',JSON.stringify(posts));
      renderPosts();
    });
  }

  function editPost(index){
    editIndex=index;
    const post=posts[index];
    document.getElementById('title').value=post.title;
    document.getElementById('description').value=post.description;
    cancelEditBtn.style.display="inline-block";
    uploadBtn.textContent="Save Changes";
    updateRemainingUploads();
  }

  updateRemainingUploads();
  renderPosts();
</script>

</body>
  </html>
  
